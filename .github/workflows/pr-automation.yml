name: PR Automation

on:
  issue_comment:
    types: [created]

jobs:
  execute:
    # Only run on PR comments with recognized commands
    if: |
      github.event.issue.pull_request &&
      (startsWith(github.event.comment.body, '[action]') ||
       startsWith(github.event.comment.body, '[fix]') ||
       startsWith(github.event.comment.body, '[debug]'))

    runs-on: ${{ vars.RUNNER_TYPE || 'ubuntu-latest' }}

    permissions:
      contents: write
      pull-requests: write
      statuses: write

    steps:
      - name: Get PR details and set pending status
        id: pr
        uses: actions/github-script@v7
        with:
          script: |
            const pr = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number
            });
            const sha = pr.data.head.sha;
            core.setOutput('branch', pr.data.head.ref);
            core.setOutput('sha', sha);

            const body = context.payload.comment.body;
            let command = 'unknown';
            let instructions = '';
            if (body.startsWith('[action]')) {
              command = 'action';
              instructions = body.slice('[action]'.length).trim();
            } else if (body.startsWith('[fix]')) {
              command = 'fix';
              instructions = body.slice('[fix]'.length).trim();
            } else if (body.startsWith('[debug]')) {
              command = 'debug';
            }
            core.setOutput('command', command);
            core.setOutput('instructions', instructions);

            // Set pending status immediately
            await github.rest.repos.createCommitStatus({
              owner: context.repo.owner,
              repo: context.repo.repo,
              sha: sha,
              state: 'pending',
              context: `PR Automation / ${command}`,
              description: 'Running...',
              target_url: `${process.env.GITHUB_SERVER_URL}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`
            });

      - name: Checkout PR branch
        uses: actions/checkout@v4
        with:
          ref: ${{ steps.pr.outputs.branch }}
          fetch-depth: 0

      - name: Setup Node.js (GitHub-hosted only)
        if: ${{ vars.RUNNER_TYPE != 'self-hosted' }}
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Claude Code CLI (GitHub-hosted only)
        if: ${{ vars.RUNNER_TYPE != 'self-hosted' }}
        run: npm install -g @anthropic-ai/claude-code

      - name: Install superpowers plugin (GitHub-hosted only)
        if: ${{ vars.RUNNER_TYPE != 'self-hosted' }}
        run: claude plugins add anthropics/claude-code-superpowers --yes

      - name: Find plan file
        id: plan
        if: steps.pr.outputs.command == 'action'
        run: |
          for f in PLAN.md plan.md .claude/plan.md docs/plan.md; do
            [ -f "$f" ] && echo "file=$f" >> $GITHUB_OUTPUT && exit 0
          done
          latest=$(ls -t docs/plans/*.md 2>/dev/null | head -1)
          [ -n "$latest" ] && echo "file=$latest" >> $GITHUB_OUTPUT && exit 0
          echo "No plan file found" && exit 1

      - name: Execute plan
        if: steps.pr.outputs.command == 'action'
        env:
          ANTHROPIC_API_KEY_SECRET: ${{ secrets.ANTHROPIC_API_KEY }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Use secret if set, otherwise use runner's env
          [ -n "$ANTHROPIC_API_KEY_SECRET" ] && export ANTHROPIC_API_KEY="$ANTHROPIC_API_KEY_SECRET"
          INSTRUCTIONS='${{ steps.pr.outputs.instructions }}'
          claude --dangerously-skip-permissions --max-turns 100 -p "
          Execute the plan in '${{ steps.plan.outputs.file }}'.
          ${INSTRUCTIONS:+
          ## Additional Instructions
          $INSTRUCTIONS
          }
          ## Process
          1. Read the plan file
          2. Use /subagent-driven-development to execute tasks
          3. Push: git push origin ${{ steps.pr.outputs.branch }}
          4. Post summary: gh pr comment ${{ github.event.issue.number }} --repo ${{ github.repository }} --body 'SUMMARY'

          ## Rules
          - Tests should be strong enough to catch regressions.
          - Do not modify tests to make them pass.
          - Test failure must be reported.
          " 2>&1 | tee claude-output.txt

      - name: Fix issues
        if: steps.pr.outputs.command == 'fix'
        env:
          ANTHROPIC_API_KEY_SECRET: ${{ secrets.ANTHROPIC_API_KEY }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Use secret if set, otherwise use runner's env
          [ -n "$ANTHROPIC_API_KEY_SECRET" ] && export ANTHROPIC_API_KEY="$ANTHROPIC_API_KEY_SECRET"

          # Gather all feedback sources
          INLINE=$(gh api repos/${{ github.repository }}/pulls/${{ github.event.issue.number }}/comments --jq '.[].body' 2>/dev/null || echo "")
          REVIEWS=$(gh api repos/${{ github.repository }}/pulls/${{ github.event.issue.number }}/reviews --jq '.[] | select(.body != "") | .body' 2>/dev/null || echo "")
          PR_COMMENTS=$(gh api repos/${{ github.repository }}/issues/${{ github.event.issue.number }}/comments --jq '.[].body' 2>/dev/null || echo "")

          # Gather CI status
          CI_STATUS=$(gh pr checks ${{ github.event.issue.number }} --repo ${{ github.repository }} 2>/dev/null || echo "")
          FAILED_RUNS=$(gh run list --branch ${{ steps.pr.outputs.branch }} --status failure --limit 3 --json databaseId,name --jq '.[] | "\(.databaseId) \(.name)"' 2>/dev/null || echo "")

          # Get failed run logs if any
          CI_LOGS=""
          for run_id in $(echo "$FAILED_RUNS" | cut -d' ' -f1); do
            [ -n "$run_id" ] && CI_LOGS="$CI_LOGS
          --- Run $run_id ---
          $(gh run view $run_id --log-failed 2>/dev/null | tail -100 || echo 'Could not fetch logs')"
          done

          INSTRUCTIONS='${{ steps.pr.outputs.instructions }}'
          claude --dangerously-skip-permissions --max-turns 100 -p "
          Fix all issues with this PR: review comments AND CI failures.
          ${INSTRUCTIONS:+
          ## Additional Instructions
          $INSTRUCTIONS
          }
          === Inline Code Comments ===
          $INLINE

          === PR Reviews ===
          $REVIEWS

          === PR Conversation ===
          $PR_COMMENTS

          === CI Status ===
          $CI_STATUS

          === Failed CI Logs (last 100 lines each) ===
          $CI_LOGS

          ## Process
          1. Use /systematic-debugging if CI failed
          2. Fix review comments and CI issues
          3. Run tests to verify: make test, cargo test, npm test, etc.
          4. Commit: git commit -am 'Fix review feedback and CI issues'
          5. Push: git push origin ${{ steps.pr.outputs.branch }}
          6. Post summary: gh pr comment ${{ github.event.issue.number }} --repo ${{ github.repository }} --body 'SUMMARY'

          ## Rules
          - All CI failures must be fixed.
          - All change requests must be either addressed or explained.
          " 2>&1 | tee claude-output.txt

      - name: Debug test
        if: steps.pr.outputs.command == 'debug'
        run: |
          echo "Debug test passed - workflow is working" | tee claude-output.txt

      - name: Upload logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: claude-output
          path: claude-output.txt
          retention-days: 7

      - name: Set success status
        if: success()
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.repos.createCommitStatus({
              owner: context.repo.owner,
              repo: context.repo.repo,
              sha: '${{ steps.pr.outputs.sha }}',
              state: 'success',
              context: 'PR Automation / ${{ steps.pr.outputs.command }}',
              description: 'Completed successfully',
              target_url: '${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}'
            });

      - name: Set failure status
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.repos.createCommitStatus({
              owner: context.repo.owner,
              repo: context.repo.repo,
              sha: '${{ steps.pr.outputs.sha }}',
              state: 'failure',
              context: 'PR Automation / ${{ steps.pr.outputs.command }}',
              description: 'Failed - check logs',
              target_url: '${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}'
            });
