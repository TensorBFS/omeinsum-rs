name: PR Automation

on:
  issue_comment:
    types: [created]

jobs:
  execute:
    # Only run on PR comments with recognized commands
    if: |
      github.event.issue.pull_request &&
      (startsWith(github.event.comment.body, '[action]') ||
       startsWith(github.event.comment.body, '[fix]') ||
       startsWith(github.event.comment.body, '[debug]'))

    runs-on: self-hosted

    permissions:
      contents: write
      pull-requests: write
      statuses: write

    steps:
      - name: Get PR details
        id: pr
        uses: actions/github-script@v7
        with:
          script: |
            const pr = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number
            });
            core.setOutput('branch', pr.data.head.ref);
            core.setOutput('sha', pr.data.head.sha);

            const body = context.payload.comment.body;
            let command = 'unknown';
            if (body.startsWith('[action]')) command = 'action';
            else if (body.startsWith('[fix]')) command = 'fix';
            else if (body.startsWith('[debug]')) command = 'debug';
            core.setOutput('command', command);

      - name: Set pending status
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.repos.createCommitStatus({
              owner: context.repo.owner,
              repo: context.repo.repo,
              sha: '${{ steps.pr.outputs.sha }}',
              state: 'pending',
              context: 'PR Automation / ${{ steps.pr.outputs.command }}',
              description: 'Running...',
              target_url: '${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}'
            });

      - name: Checkout PR branch
        uses: actions/checkout@v4
        with:
          ref: ${{ steps.pr.outputs.branch }}
          fetch-depth: 0

      - name: Setup Node.js (GitHub-hosted only)
        if: ${{ !contains(runner.name, 'self-hosted') }}
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Claude Code CLI (GitHub-hosted only)
        if: ${{ !contains(runner.name, 'self-hosted') }}
        run: npm install -g @anthropic-ai/claude-code

      - name: Find plan file
        id: plan
        if: steps.pr.outputs.command == 'action'
        run: |
          for f in PLAN.md plan.md .claude/plan.md docs/plan.md; do
            [ -f "$f" ] && echo "file=$f" >> $GITHUB_OUTPUT && exit 0
          done
          latest=$(ls -t docs/plans/*.md 2>/dev/null | head -1)
          [ -n "$latest" ] && echo "file=$latest" >> $GITHUB_OUTPUT && exit 0
          echo "No plan file found" && exit 1

      - name: Execute plan
        if: steps.pr.outputs.command == 'action'
        env:
          ANTHROPIC_API_KEY_SECRET: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          # Use secret if set, otherwise use runner's env
          [ -n "$ANTHROPIC_API_KEY_SECRET" ] && export ANTHROPIC_API_KEY="$ANTHROPIC_API_KEY_SECRET"
          claude --dangerously-skip-permissions --max-turns 100 -p "
          Execute the plan in '${{ steps.plan.outputs.file }}'.

          Instructions:
          1. Read the plan file carefully
          2. Implement each step in order
          3. Commit changes with descriptive messages
          4. Push changes: git push origin ${{ steps.pr.outputs.branch }}
          " 2>&1 | tee claude-output.txt

      - name: Fix review comments
        if: steps.pr.outputs.command == 'fix'
        env:
          ANTHROPIC_API_KEY_SECRET: ${{ secrets.ANTHROPIC_API_KEY }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Use secret if set, otherwise use runner's env
          [ -n "$ANTHROPIC_API_KEY_SECRET" ] && export ANTHROPIC_API_KEY="$ANTHROPIC_API_KEY_SECRET"
          INLINE=$(gh api repos/${{ github.repository }}/pulls/${{ github.event.issue.number }}/comments --jq '.[].body' 2>/dev/null || echo "")
          REVIEWS=$(gh api repos/${{ github.repository }}/pulls/${{ github.event.issue.number }}/reviews --jq '.[] | select(.body != "") | .body' 2>/dev/null || echo "")

          claude --dangerously-skip-permissions --max-turns 100 -p "
          Address the PR review comments.

          === Inline Review Comments ===
          $INLINE

          === PR Reviews ===
          $REVIEWS

          Instructions:
          1. Read each comment and understand what change is requested
          2. Make the requested changes to the code
          3. Commit: git commit -am 'Address PR review feedback'
          4. Push: git push origin ${{ steps.pr.outputs.branch }}
          " 2>&1 | tee claude-output.txt

      - name: Debug test
        if: steps.pr.outputs.command == 'debug'
        run: |
          echo "Debug test passed - workflow is working" | tee claude-output.txt

      - name: Upload logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: claude-output
          path: claude-output.txt
          retention-days: 7

      - name: Set success status
        if: success()
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.repos.createCommitStatus({
              owner: context.repo.owner,
              repo: context.repo.repo,
              sha: '${{ steps.pr.outputs.sha }}',
              state: 'success',
              context: 'PR Automation / ${{ steps.pr.outputs.command }}',
              description: 'Completed successfully',
              target_url: '${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}'
            });

      - name: Set failure status
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.repos.createCommitStatus({
              owner: context.repo.owner,
              repo: context.repo.repo,
              sha: '${{ steps.pr.outputs.sha }}',
              state: 'failure',
              context: 'PR Automation / ${{ steps.pr.outputs.command }}',
              description: 'Failed - check logs',
              target_url: '${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}'
            });
